# Story 0.0: Firebase Project & Cloud Setup

## Status
Pending

## Story
**As a** Development Team,  
**I want** a properly configured Firebase project with all required services,  
**so that** we can build features on a secure, EU-compliant cloud infrastructure

## Acceptance Criteria
1. Firebase project created in EU region (europe-west1)
2. Authentication providers configured (Email/Password)
3. Firestore database initialized with security rules
4. Firebase Storage buckets created in EU region
5. Cloud Functions region set to EU
6. Environment configuration files generated
7. Service account keys created for CI/CD
8. Budget alerts and quotas configured

## Tasks / Subtasks
- [ ] Create Firebase Project (AC: 1)
  - [ ] Log into Firebase Console with project owner account
  - [ ] Create new project named "stadtdeals-prod"
  - [ ] Enable Google Analytics with EU region
  - [ ] Set project ID to match app bundle identifier
- [ ] Configure Authentication (AC: 2)
  - [ ] Enable Email/Password authentication
  - [ ] Configure email templates for OTP
  - [ ] Set up authorized domains
  - [ ] Configure SMS quota for future use
- [ ] Initialize Firestore Database (AC: 3)
  - [ ] Create Firestore in EU region (europe-west3)
  - [ ] Set up initial security rules (restrictive)
  - [ ] Create required composite indexes
  - [ ] Enable offline persistence settings
- [ ] Set up Firebase Storage (AC: 4)
  - [ ] Create default bucket in EU region
  - [ ] Configure CORS for app access
  - [ ] Set up security rules for user uploads
  - [ ] Create folder structure (/users, /vendors, /products)
- [ ] Configure Cloud Functions (AC: 5)
  - [ ] Initialize Functions with TypeScript
  - [ ] Set default region to europe-west1
  - [ ] Configure memory and timeout defaults
  - [ ] Set up environment variables structure
- [ ] Generate Configuration Files (AC: 6)
  - [ ] Download google-services.json (Android)
  - [ ] Download GoogleService-Info.plist (iOS)
  - [ ] Create .env file with Firebase config
  - [ ] Document all configuration values
- [ ] Set up CI/CD Access (AC: 7)
  - [ ] Create service account for deployments
  - [ ] Generate and secure private keys
  - [ ] Configure IAM roles appropriately
  - [ ] Test deployment permissions
- [ ] Configure Monitoring & Budgets (AC: 8)
  - [ ] Set up budget alerts at €50, €100, €200
  - [ ] Configure quota limits for Auth, Firestore
  - [ ] Enable monitoring dashboards
  - [ ] Set up error alerting

## Dev Notes

### Firebase Console URLs
- Console: https://console.firebase.google.com
- Project Settings: [project]/settings/general
- Service Accounts: [project]/settings/serviceaccounts/adminsdk

### Initial Security Rules

**Firestore Rules:**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Temporary restrictive rules - to be updated per epic
    match /{document=**} {
      allow read, write: if false;
    }
    
    // Allow users to read their own profile
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

**Storage Rules:**
```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // User profile images
    match /users/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
        && request.resource.size < 5 * 1024 * 1024 // 5MB limit
        && request.resource.contentType.matches('image/.*');
    }
    
    // Vendor images - temporary restrictive
    match /vendors/{vendorId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if false; // To be updated in Epic 2
    }
  }
}
```

### Environment Configuration Template

**.env file structure:**
```bash
# Firebase Configuration
FIREBASE_PROJECT_ID=stadtdeals-prod
FIREBASE_API_KEY=your-api-key
FIREBASE_AUTH_DOMAIN=stadtdeals-prod.firebaseapp.com
FIREBASE_STORAGE_BUCKET=stadtdeals-prod.appspot.com
FIREBASE_MESSAGING_SENDER_ID=your-sender-id
FIREBASE_APP_ID=your-app-id
FIREBASE_MEASUREMENT_ID=your-measurement-id

# Cloud Functions
FUNCTIONS_REGION=europe-west1

# Feature Flags
ENABLE_CRASHLYTICS=true
ENABLE_ANALYTICS=true
```

### Budget Configuration
- Monthly budget cap: €200 (initial MVP phase)
- Alert thresholds: 25% (€50), 50% (€100), 100% (€200)
- Auto-shutdown at 120% to prevent overages

### Composite Indexes Required
```json
[
  {
    "collectionGroup": "products",
    "queryScope": "COLLECTION",
    "fields": [
      { "fieldPath": "vendorId", "order": "ASCENDING" },
      { "fieldPath": "status", "order": "ASCENDING" },
      { "fieldPath": "createdAt", "order": "DESCENDING" }
    ]
  },
  {
    "collectionGroup": "orders",
    "queryScope": "COLLECTION", 
    "fields": [
      { "fieldPath": "customerId", "order": "ASCENDING" },
      { "fieldPath": "status", "order": "ASCENDING" },
      { "fieldPath": "createdAt", "order": "DESCENDING" }
    ]
  }
]
```

## Testing

### Verification Checklist
- [ ] Firebase Console shows project in EU region
- [ ] Authentication test: Can create test user via console
- [ ] Firestore test: Can create test document with security rules
- [ ] Storage test: Can upload test image via console
- [ ] Functions test: Deploy hello-world function successfully
- [ ] Environment test: App connects with configuration files
- [ ] CI/CD test: GitHub Actions can deploy functions
- [ ] Budget test: Alerts are received at test threshold

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-07-31 | 1.0 | Initial story creation | Sarah (Product Owner) |